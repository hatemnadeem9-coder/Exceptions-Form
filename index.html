<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exceptions Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .readonly-input {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-4xl">
        <!-- Form Container -->
        <div id="form-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 fade-in">
            <div class="mb-6 text-center">
                <h1 class="text-3xl font-bold text-gray-800">Exceptions Form</h1>
                <p class="text-gray-500 mt-2">Please fill out the details for your Exception request below.</p>
            </div>
            
            <form id="event-form">
                <!-- Main Details Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="agent-id" class="block text-sm font-medium text-gray-700 mb-1">ID</label>
                        <input type="text" id="agent-id" list="agent-id-list" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Type to search for ID...">
                        <datalist id="agent-id-list">
                            <!-- IDs will be populated by JavaScript -->
                        </datalist>
                    </div>
                    <div>
                        <label for="agent-name" class="block text-sm font-medium text-gray-700 mb-1">Agent Name</label>
                        <input type="text" id="agent-name" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg readonly-input">
                    </div>
                    <div>
                        <label for="team-leader" class="block text-sm font-medium text-gray-700 mb-1">Team Leader</label>
                        <input type="text" id="team-leader" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg readonly-input">
                    </div>
                     <div>
                        <label for="hr-code" class="block text-sm font-medium text-gray-700 mb-1">HR Code</label>
                        <input type="text" id="hr-code" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg readonly-input">
                    </div>
                </div>

                <!-- Dynamic Date and Time Section -->
                <div class="space-y-4 mb-6" id="date-time-section">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Activity Details</h2>
                    <!-- This container will hold the dynamically added date/time fields -->
                </div>

                <!-- Action Buttons for Dates -->
                <div class="flex items-center gap-4 mb-8">
                    <button type="button" id="add-date-btn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition shadow-sm">
                        Add Entry
                    </button>
                    <p id="date-counter" class="text-sm text-gray-500">1 of 10 entries added.</p>
                </div>

                <!-- Form Submission Button -->
                <div class="text-center">
                    <button type="submit" id="submit-btn" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                        Submit
                    </button>
                </div>
            </form>
            <!-- Signature -->
            <div class="text-center border-t border-gray-200 pt-4 mt-8">
                <p class="text-base text-orange-500 font-semibold">By : Hatem Medhat - WFM Team</p>
            </div>
        </div>

        <!-- Submission Status Container (Initially Hidden) -->
        <div id="submission-status-container" class="hidden bg-white p-8 rounded-xl shadow-lg border border-gray-200 fade-in text-center">
             <div id="loading-spinner" class="spinner mx-auto mb-4"></div>
             <h2 id="status-heading" class="text-2xl font-bold text-gray-800">Submitting...</h2>
             <p id="status-message" class="text-gray-600 mt-2">Please wait while we send your activity details.</p>
             <div class="text-center mt-8">
                <button id="new-form-btn" class="hidden bg-gray-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition shadow-sm">
                    Submit Another Response
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Agent Data from your new provided sheet ---
           const agentsData = [{ id: 'X2003111', agentName: 'Abanoub Makram', tl: 'maher', hrCode: '825811' }, { id: 'X2047656', agentName: 'Abdel Aaziz Ashraf', tl: 'Kirolos', hrCode: '838865' }, { id: 'X2027633', agentName: 'AbdElrahman Adel Mohamed', tl: 'Kirolos', hrCode: '832336' }, { id: 'X1264160', agentName: 'Abdelrahman Salem', tl: 'Youhana', hrCode: '821310' }, { id: 'X1387122', agentName: 'Abdullah Tariq', tl: 'maher', hrCode: '824283' }, { id: 'X2091475', agentName: 'Ahmed Elmohamdi', tl: 'Kirolos', hrCode: '844909' }, { id: 'X2100111', agentName: 'Alaa Hamdy', tl: 'Youhana', hrCode: '844985' }, { id: 'X1370543', agentName: 'Alaa Tariq', tl: 'maher', hrCode: '824262' }, { id: 'X1264180', agentName: 'Ali Ashraf', tl: 'Hamed', hrCode: '821313' }, { id: 'X2065273', agentName: 'Ali Mohamed', tl: 'Youhana', hrCode: '838916' }, { id: 'YEG002272', agentName: 'Alshimaa Ahmed', tl: 'Youhana', hrCode: '40544' }, { id: 'X2094368', agentName: 'Amal Ahmed', tl: 'Kirolos', hrCode: '844965' }, { id: 'X2040351', agentName: 'Amani Assem', tl: 'Kirolos', hrCode: '835769' }, { id: 'X1325802', agentName: 'Amr Ahmed', tl: 'maher', hrCode: '823222' }, { id: 'X2079589', agentName: 'Anoud Mohamed', tl: 'Kirolos', hrCode: '842569' }, { id: 'X2077125', agentName: 'Aya Nabil', tl: 'maher', hrCode: '842554' }, { id: 'X1277043', agentName: 'Aya Rajab', tl: 'Hamed', hrCode: '821327' }, { id: 'X2047645', agentName: 'Bassant Beshara Nasif', tl: 'Kirolos', hrCode: '838869' }, { id: 'X614369', agentName: 'David Emad', tl: 'maher', hrCode: '40571' }, { id: 'X1325780', agentName: 'Dina Ahmad', tl: 'Kirolos', hrCode: '823219' }, { id: 'X2082076', agentName: 'Dina Atef', tl: 'Youhana', hrCode: '843488' }, { id: 'X2043492', agentName: 'Doaa Ahmed', tl: 'Youhana', hrCode: '837343' }, { id: 'X2141343', agentName: 'Donia Hosny', tl: 'Kirolos', hrCode: '851046' }, { id: 'X2040719', agentName: 'Ebtisam Mahrous Mohamed', tl: 'Kirolos', hrCode: '835792' }, { id: 'X2040350', agentName: 'Elaria Atef', tl: 'Kirolos', hrCode: '835770' }, { id: 'YEG002733', agentName: 'Elham Abdul Salam', tl: 'Youhana', hrCode: '40541' }, { id: 'X1277023', agentName: 'Eman Hussny', tl: 'maher', hrCode: '821322' }, { id: 'X1370544', agentName: 'Enas Adel', tl: 'Youhana', hrCode: '824263' }, { id: 'X2082078', agentName: 'Eslam Ahmed', tl: 'maher', hrCode: '843489' }, { id: 'X1264181', agentName: 'Esraa Ahmed', tl: 'Hamed', hrCode: '821315' }, { id: 'X2082079', agentName: 'Esraa Ebrahim', tl: 'Youhana', hrCode: '843490' }, { id: 'X2077124', agentName: 'Farah Atef', tl: 'Kirolos', hrCode: '842553' }, { id: 'X2047646', agentName: 'Fayrouz Fanos Fahim', tl: 'Kirolos', hrCode: '838866' }, { id: 'X2141356', agentName: 'Filopateer boshra', tl: 'Youhana', hrCode: '851047' }, { id: 'X2082080', agentName: 'Hager Magdy', tl: 'Kirolos', hrCode: '843491' }, { id: 'YEG003047', agentName: 'Hesham Yousry', tl: 'Youhana', hrCode: '40562' }, { id: 'X2141349', agentName: 'Ibraheem mamdoh', tl: 'Kirolos', hrCode: '851049' }, { id: 'X788262', agentName: 'Islam Siam', tl: 'Kirolos', hrCode: '40687' }, { id: 'X783265', agentName: 'Lama Nabil', tl: 'Hamed', hrCode: '40681' }, { id: 'X2068123', agentName: 'Lamia Essam', tl: 'Kirolos', hrCode: '838920' }, { id: 'X1325800', agentName: 'Maha Muhammad', tl: 'Hamed', hrCode: '823221' }, { id: 'X1002723', agentName: 'Maha Tarek', tl: 'Youhana', hrCode: '40893' }, { id: 'X2065278', agentName: 'Mahmoud Ahmed', tl: 'Youhana', hrCode: '838918' }, { id: 'X822440', agentName: 'Mahmoud Gamal', tl: 'Kirolos', hrCode: '40702' }, { id: 'X1277025', agentName: 'Mahmoud Muhammed', tl: 'Hamed', hrCode: '821324' }, { id: 'X2094364', agentName: 'Mahmoud Rashad', tl: 'Youhana', hrCode: '844963' }, { id: 'X2142026', agentName: 'Mahrail Magid', tl: 'Kirolos', hrCode: '851050' }, { id: 'X2100108', agentName: 'Malak Abdel Nasser', tl: 'Youhana', hrCode: '844982' }, { id: 'X2046109', agentName: 'Manal Mohamed Mostafa', tl: 'Kirolos', hrCode: '837345' }, { id: 'X2015516', agentName: 'Maram Mohamed', tl: 'Youhana', hrCode: '827882' }, { id: 'X2141348', agentName: 'Mariam nasser', tl: 'Kirolos', hrCode: '851051' }, { id: 'X2122169', agentName: 'Martina Nabil', tl: 'Kirolos', hrCode: '851026' }, { id: 'X1285441', agentName: 'Mayada Ali', tl: 'Youhana', hrCode: '821337' }, { id: 'X2082088', agentName: 'Mayer Ismail', tl: 'Kirolos', hrCode: '843493' }, { id: 'X722281', agentName: 'Mina Ezat', tl: 'Youhana', hrCode: '40369' }, { id: 'X2002024', agentName: 'MinaMelad', tl: 'maher', hrCode: '825804' }, { id: 'X1160340', agentName: 'Moamen Samy', tl: 'maher', hrCode: '817339' }, { id: 'X1059943', agentName: 'Mohamed Ahmed', tl: 'Hamed', hrCode: '40951' }, { id: 'X2046113', agentName: 'Mohamed Hamed Atya', tl: 'Youhana', hrCode: '837347' }, { id: 'X2141350', agentName: 'Mohammed ibraheem', tl: 'Kirolos', hrCode: '851052' }, { id: 'X2141351', agentName: 'Mona hassan', tl: 'Kirolos', hrCode: '851054' }, { id: 'X723901', agentName: 'Mosaab Ali', tl: 'Hamed', hrCode: '40628' }, { id: 'X1387129', agentName: 'Muhammad Ismail', tl: 'maher', hrCode: '824284' }, { id: 'X1277020', agentName: 'Muhammed Fathi', tl: 'Hamed', hrCode: '821319' }, { id: 'X2122166', agentName: 'Nada Hamada', tl: 'Kirolos', hrCode: '851055' }, { id: 'X2108397', agentName: 'Nermine Elfeki', tl: 'Kirolos', hrCode: '848192' }, { id: 'X2082090', agentName: 'Nesma Mohamed', tl: 'Kirolos', hrCode: '843495' }, { id: 'X2141339', agentName: 'Noha sameer', tl: 'Kirolos', hrCode: '851056' }, { id: 'X1075901', agentName: 'Nourhan Salah', tl: 'Youhana', hrCode: '40986' }, { id: 'X2002022', agentName: 'NourhanMohamed', tl: 'maher', hrCode: '825802' }, { id: 'X2089012', agentName: 'Rana Shawky', tl: 'Kirolos', hrCode: '844970' }, { id: 'X2048908', agentName: 'Rania Abdelsalam', tl: 'Kirolos', hrCode: '838909' }, { id: 'X2141359', agentName: 'rawan ismael', tl: 'Youhana', hrCode: '851045' }, { id: 'X774963', agentName: 'Reham Nabil', tl: 'Hamed', hrCode: '40668' }, { id: 'X2089357', agentName: 'Rehan Mostafa', tl: 'Kirolos', hrCode: '844913' }, { id: 'X738720', agentName: 'Saad Saad', tl: 'Hamed', hrCode: '40657' }, { id: 'X2122168', agentName: 'Sama Roshdi', tl: 'Kirolos', hrCode: '851027' }, { id: 'X1387120', agentName: 'Samar Muhammad', tl: 'Kirolos', hrCode: '824286' }, { id: 'YEG003051', agentName: 'Sara sayed', tl: 'Youhana', hrCode: '40869' }, { id: 'X2002027', agentName: 'Sarah Fakhry', tl: 'maher', hrCode: '819888' }, { id: 'X2089355', agentName: 'Sherin Sayed', tl: 'Youhana', hrCode: '844911' }, { id: 'X1264162', agentName: 'Shimaa Muhammed', tl: 'Hamed', hrCode: '821317' }, { id: 'X2079590', agentName: 'Shourok Sayed', tl: 'Kirolos', hrCode: '842570' }, { id: 'X1310300', agentName: 'Sihar Ashraf', tl: 'Kirolos', hrCode: '823203' }, { id: 'X626980', agentName: 'Silvana Emad', tl: 'Youhana', hrCode: '40583' }, { id: 'X2047644', agentName: 'Sohaila Mohamed Abd Elwahed', tl: 'Hamed', hrCode: '838870' }, { id: 'X1160361', agentName: 'Sohila Mahmoud', tl: 'Hamed', hrCode: '817341' }, { id: 'X2043494', agentName: 'Suhaila aLSAYED aLMORSI', tl: 'Kirolos', hrCode: '837344' }, { id: 'X2017209', agentName: 'Suzan Magdy', tl: 'Kirolos', hrCode: '830209' }, { id: 'YEG002235', agentName: 'Tamer Refaei', tl: 'maher', hrCode: '40516' }, { id: 'X626981', agentName: 'Triza Saber', tl: 'Kirolos', hrCode: '40586' }, { id: 'X2090310', agentName: 'Yara Emad', tl: 'Kirolos', hrCode: '844971' }, { id: 'X2090314', agentName: 'Yasmine Ezzeldin', tl: 'Kirolos', hrCode: '844972' }, { id: 'X2082095', agentName: 'Yostina Hany', tl: 'Kirolos', hrCode: '843497' }, { id: 'X2144482', agentName: 'Hajar Abdallah', tl: 'Kirolos', hrCode: '851085' }, { id: 'X2144481', agentName: 'Sondos Saleh', tl: 'Kirolos', hrCode: '851084' }, { id: 'X2145008', agentName: 'Hager Youssef', tl: 'Kirolos', hrCode: '851087' }, { id: 'X2144479', agentName: 'Kamal Ghonim', tl: 'Kirolos', hrCode: '851083' }, { id: 'X2148372', agentName: 'Shaimaa Tarek', tl: 'Kirolos', hrCode: '854354' }, { id: 'X2147221', agentName: 'Hadeer Fathy', tl: 'Kirolos', hrCode: '854352' }, { id: 'X2144483', agentName: 'Salma Yehia', tl: 'Kirolos', hrCode: '851086' }, { id: 'X2145009', agentName: 'Manar Abdelaziz', tl: 'Kirolos', hrCode: '851082' }, { id: 'X2151365', agentName: 'Salma El Rashidy', tl: 'Kirolos', hrCode: '854358' }, { id: 'X2151369', agentName: 'Sama Ehab', tl: 'Kirolos', hrCode: '854361' }, { id: 'X2151367', agentName: 'Hager Hussien', tl: 'Kirolos', hrCode: '854359' }];

            // --- DOM Element References ---
            const form = document.getElementById('event-form');
            const agentIdInput = document.getElementById('agent-id');
            const agentNameInput = document.getElementById('agent-name');
            const hrCodeInput = document.getElementById('hr-code');
            const teamLeaderInput = document.getElementById('team-leader');
            const dateTimeSection = document.getElementById('date-time-section');
            const addDateBtn = document.getElementById('add-date-btn');
            const dateCounter = document.getElementById('date-counter');
            const formContainer = document.getElementById('form-container');
            const newFormBtn = document.getElementById('new-form-btn');
            const statusContainer = document.getElementById('submission-status-container');
            const statusHeading = document.getElementById('status-heading');
            const statusMessage = document.getElementById('status-message');
            const loadingSpinner = document.getElementById('loading-spinner');

            // !!! IMPORTANT: THIS URL SHOULD BE YOUR GOOGLE APPS SCRIPT URL !!!
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwna5m8b8_CVh3ClsO-KO9YkiTsPSB0azIjOgIAHTlNdQmSJPQu-4ZmsTekAbNWzDU01A/exec";

            const MAX_ENTRIES = 10;
            let entryCount = 0;

            // --- Functions ---
            const populateIds = () => {
                const dataList = document.getElementById('agent-id-list');
                agentsData.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    dataList.appendChild(option);
                });
            };

            const handleIdChange = (e) => {
                const selectedId = e.target.value;
                const selectedAgent = agentsData.find(agent => agent.id === selectedId);

                if (selectedAgent) {
                    agentNameInput.value = selectedAgent.agentName;
                    hrCodeInput.value = selectedAgent.hrCode;
                    teamLeaderInput.value = selectedAgent.tl;
                } else {
                    agentNameInput.value = '';
                    hrCodeInput.value = '';
                    teamLeaderInput.value = '';
                }
            };

            const updateEntryCounter = () => {
                dateCounter.textContent = `${entryCount} of ${MAX_ENTRIES} entries added.`;
                addDateBtn.disabled = entryCount >= MAX_ENTRIES;
                addDateBtn.classList.toggle('opacity-50', entryCount >= MAX_ENTRIES);
                addDateBtn.classList.toggle('cursor-not-allowed', entryCount >= MAX_ENTRIES);
            };

            const addDateTimeEntry = () => {
                if (entryCount >= MAX_ENTRIES) return;
                entryCount++;

                const entryId = `date-entry-${entryCount}`;
                const entryDiv = document.createElement('div');
                entryDiv.className = 'p-4 border rounded-lg bg-gray-50 fade-in space-y-4';
                entryDiv.id = entryId;

                entryDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-gray-600">Entry #${entryCount}</h3>
                        ${entryCount > 1 ? `<button type="button" class="remove-date-btn text-red-500 hover:text-red-700 font-semibold text-sm" data-target="${entryId}">Remove</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                            <label for="exception-type-${entryCount}" class="block text-sm font-medium text-gray-700 mb-1">Exception Type</label>
                            <select id="exception-type-${entryCount}" name="exception-type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                                <option value="" disabled selected>Select a Type</option>
                                <option value="Follow up">Follow up</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Shadowing">Shadowing</option>
                                <option value="Happy Call">Happy Call</option>
                                <option value="Task">Task</option>
                                <option value="Technical issue">Technical issue</option>
                                <option value="Training">Training</option>
                                <option value="Support">Support</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="exception-reason-${entryCount}" class="block text-sm font-medium text-gray-700 mb-1">Exception Reason</label>
                            <textarea id="exception-reason-${entryCount}" name="exception-reason" rows="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 pt-2">
                        <div>
                            <label for="date-${entryCount}" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="date-${entryCount}" name="event-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="time-from-${entryCount}" class="block text-sm font-medium text-gray-700 mb-1">From</label>
                            <input type="time" id="time-from-${entryCount}" name="time-from" required class="time-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="time-to-${entryCount}" class="block text-sm font-medium text-gray-700 mb-1">To</label>
                            <input type="time" id="time-to-${entryCount}" name="time-to" required class="time-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="duration-${entryCount}" class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
                            <input type="text" id="duration-${entryCount}" name="duration" readonly class="duration-output w-full px-3 py-2 border border-gray-200 bg-gray-100 rounded-lg readonly-input">
                        </div>
                    </div>
                `;
                dateTimeSection.appendChild(entryDiv);
                updateEntryCounter();
            };

            const calculateDuration = (timeFrom, timeTo) => {
                if (!timeFrom || !timeTo) return '';
                const from = new Date(`1970-01-01T${timeFrom}:00`);
                const to = new Date(`1970-01-01T${timeTo}:00`);
                let diff = to.getTime() - from.getTime();
                if (diff < 0) diff += 24 * 60 * 60 * 1000;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}h ${minutes}m`;
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                if (SCRIPT_URL === "PASTE_YOUR_WEB_APP_URL_HERE") {
                    alert("Please paste your Google Apps Script URL into the SCRIPT_URL constant in the HTML file.");
                    return;
                }

                formContainer.classList.add('hidden');
                statusContainer.classList.remove('hidden');
                loadingSpinner.style.display = 'block';
                statusHeading.textContent = 'Submitting...';
                statusMessage.textContent = 'Please wait while we send your activity details.';
                newFormBtn.classList.add('hidden');

                const baseData = {
                    agentId: document.getElementById('agent-id').value,
                    agentName: document.getElementById('agent-name').value,
                    teamLeader: document.getElementById('team-leader').value,
                    hrCode: document.getElementById('hr-code').value,
                };

                const dateEntries = document.querySelectorAll('[id^="date-entry-"]');
                const submissionPromises = [];

                dateEntries.forEach(entry => {
                    const entryNumber = entry.id.split('-')[2];
                    const exceptionType = entry.querySelector(`#exception-type-${entryNumber}`).value;
                    const exceptionReason = entry.querySelector(`#exception-reason-${entryNumber}`).value;
                    const date = entry.querySelector(`#date-${entryNumber}`).value;
                    const timeFrom = entry.querySelector(`#time-from-${entryNumber}`).value;
                    const timeTo = entry.querySelector(`#time-to-${entryNumber}`).value;
                    const duration = entry.querySelector(`#duration-${entryNumber}`).value;

                    if (date && timeFrom && timeTo) {
                        const rowData = { ...baseData, exceptionType, exceptionReason, date, timeFrom, timeTo, duration };
                        const promise = fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            cache: 'no-cache',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(rowData),
                            redirect: 'follow'
                        });
                        submissionPromises.push(promise);
                    }
                });

                try {
                    await Promise.all(submissionPromises);
                    loadingSpinner.style.display = 'none';
                    statusHeading.textContent = 'Submission Successful!';
                    statusMessage.textContent = 'Your activity has been recorded in the Google Sheet.';
                } catch (error) {
                    console.error('Error submitting form:', error);
                    loadingSpinner.style.display = 'none';
                    statusHeading.textContent = 'Submission Failed';
                    statusMessage.textContent = 'An error occurred. Please try again.';
                } finally {
                    newFormBtn.classList.remove('hidden');
                }
            };
            
            const resetFormView = () => {
                form.reset();
                dateTimeSection.innerHTML = '';
                agentNameInput.value = '';
                hrCodeInput.value = '';
                teamLeaderInput.value = '';
                entryCount = 0;
                addDateTimeEntry();
                statusContainer.classList.add('hidden');
                formContainer.classList.remove('hidden');
            };

            // --- Event Listeners ---
            agentIdInput.addEventListener('input', handleIdChange);
            addDateBtn.addEventListener('click', addDateTimeEntry);

            dateTimeSection.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-date-btn')) {
                    const targetId = e.target.dataset.target;
                    document.getElementById(targetId)?.remove();
                    entryCount--;
                    updateEntryCounter();
                }
            });

            dateTimeSection.addEventListener('input', (e) => {
                 if (e.target.classList.contains('time-input')) {
                    const parentEntry = e.target.closest('[id^="date-entry-"]');
                    const timeFrom = parentEntry.querySelector('input[name="time-from"]').value;
                    const timeTo = parentEntry.querySelector('input[name="time-to"]').value;
                    const durationOutput = parentEntry.querySelector('.duration-output');
                    durationOutput.value = calculateDuration(timeFrom, timeTo);
                 }
            });

            form.addEventListener('submit', handleFormSubmit);
            newFormBtn.addEventListener('click', resetFormView);

            // --- Initial Setup ---
            populateIds();
            addDateTimeEntry();
        });
    </script>
</body>
</html>



